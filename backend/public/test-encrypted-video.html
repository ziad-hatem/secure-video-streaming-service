<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Encrypted Video Test</title>
        <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f5f5f5;
            }
            .container {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            video {
                width: 100%;
                max-width: 640px;
                height: auto;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            }
            .info {
                margin-top: 20px;
                padding: 15px;
                background-color: #e8f4fd;
                border-left: 4px solid #2196f3;
                border-radius: 4px;
            }
            .status {
                margin-top: 10px;
                padding: 10px;
                border-radius: 4px;
                font-weight: bold;
            }
            .success {
                background-color: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            .error {
                background-color: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
            .warning {
                background-color: #fff3cd;
                color: #856404;
                border: 1px solid #ffeaa7;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üîê Encrypted Video Streaming Test</h1>

            <video id="video" controls muted>
                <p>Your browser doesn't support HTML5 video.</p>
            </video>

            <div class="info">
                <h3>üîí Security Features:</h3>
                <ul>
                    <li>
                        <strong>AES-128 Encryption:</strong> All video segments
                        are encrypted
                    </li>
                    <li>
                        <strong>Secure Key Serving:</strong> Encryption keys
                        served via authenticated endpoint
                    </li>
                    <li>
                        <strong>Random Segment Names:</strong> Segments have
                        unpredictable names
                    </li>
                    <li>
                        <strong>CORS Protection:</strong> Cross-origin access
                        controls
                    </li>
                </ul>
            </div>

            <div id="status" class="status warning">
                üîÑ Initializing encrypted video player...
            </div>

            <div
                id="debug"
                style="
                    margin-top: 20px;
                    font-family: monospace;
                    font-size: 12px;
                    background: #f8f9fa;
                    padding: 10px;
                    border-radius: 4px;
                    max-height: 200px;
                    overflow-y: auto;
                "
            >
                <strong>Debug Log:</strong><br />
            </div>
        </div>

        <script>
            const video = document.getElementById("video");
            const statusDiv = document.getElementById("status");
            const debugDiv = document.getElementById("debug");

            function log(message) {
                console.log(message);
                debugDiv.innerHTML +=
                    new Date().toLocaleTimeString() + ": " + message + "<br>";
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }

            function updateStatus(message, type = "warning") {
                statusDiv.textContent = message;
                statusDiv.className = "status " + type;
            }

            // Test encrypted video URL
            const videoUrl = "/api/hls/56/master.m3u8";

            log("üöÄ Starting encrypted video test...");
            log("üì∫ Video URL: " + videoUrl);

            if (Hls.isSupported()) {
                log("‚úÖ HLS.js is supported");
                updateStatus("üîÑ Loading encrypted video...", "warning");

                const hls = new Hls({
                    debug: true,
                    enableWorker: true,
                    lowLatencyMode: false,
                    backBufferLength: 90,
                });

                // Event listeners
                hls.on(Hls.Events.MEDIA_ATTACHED, function () {
                    log("üì± Media attached to video element");
                });

                hls.on(Hls.Events.MANIFEST_LOADED, function (event, data) {
                    log("üìã Master playlist loaded successfully");
                    log("üìä Available levels: " + data.levels.length);
                    data.levels.forEach((level, index) => {
                        log(
                            `   Level ${index}: ${level.width}x${level.height} @ ${level.bitrate}bps`
                        );
                    });
                });

                hls.on(Hls.Events.LEVEL_LOADED, function (event, data) {
                    log("üé¨ Level playlist loaded: " + data.details.url);
                    log(
                        "üîê Segments: " +
                            data.details.fragments.length +
                            " encrypted segments"
                    );
                });

                hls.on(Hls.Events.KEY_LOADED, function (event, data) {
                    log("üîë Encryption key loaded successfully");
                    log("üîê Key URI: " + data.frag.decryptdata.uri);
                });

                hls.on(Hls.Events.FRAG_LOADED, function (event, data) {
                    log(
                        "üì¶ Encrypted segment loaded and decrypted: " +
                            data.frag.url
                    );
                });

                hls.on(Hls.Events.LEVEL_SWITCHED, function (event, data) {
                    log("üîÑ Quality switched to level: " + data.level);
                });

                hls.on(Hls.Events.ERROR, function (event, data) {
                    log("‚ùå HLS Error: " + data.type + " - " + data.details);
                    if (data.fatal) {
                        updateStatus(
                            "‚ùå Fatal error: " + data.details,
                            "error"
                        );
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                log("üåê Network error, trying to recover...");
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                log("üì∫ Media error, trying to recover...");
                                hls.recoverMediaError();
                                break;
                            default:
                                log("üí• Unrecoverable error");
                                hls.destroy();
                                break;
                        }
                    }
                });

                // Video element events
                video.addEventListener("loadstart", () => {
                    log("üì∫ Video load started");
                    updateStatus(
                        "üîÑ Loading encrypted video data...",
                        "warning"
                    );
                });

                video.addEventListener("loadedmetadata", () => {
                    log("üìä Video metadata loaded");
                    log(
                        `üìê Video dimensions: ${video.videoWidth}x${video.videoHeight}`
                    );
                    log(`‚è±Ô∏è Duration: ${video.duration.toFixed(2)} seconds`);
                    updateStatus(
                        "‚úÖ Encrypted video loaded successfully!",
                        "success"
                    );
                });

                video.addEventListener("canplay", () => {
                    log("‚ñ∂Ô∏è Video can start playing");
                    updateStatus(
                        "üé¨ Ready to play encrypted video!",
                        "success"
                    );
                });

                video.addEventListener("playing", () => {
                    log("üé¨ Video is playing");
                    updateStatus("üé¨ Playing encrypted video!", "success");
                });

                video.addEventListener("error", (e) => {
                    log("‚ùå Video error: " + e.message);
                    updateStatus("‚ùå Video playback error", "error");
                });

                // Load the encrypted video
                hls.loadSource(videoUrl);
                hls.attachMedia(video);
            } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
                log("üçé Native HLS support detected");
                updateStatus("üîÑ Loading with native HLS...", "warning");
                video.src = videoUrl;

                video.addEventListener("loadedmetadata", () => {
                    log("‚úÖ Video loaded with native HLS");
                    updateStatus("‚úÖ Encrypted video loaded!", "success");
                });
            } else {
                log("‚ùå HLS not supported");
                updateStatus("‚ùå HLS not supported in this browser", "error");
            }
        </script>
    </body>
</html>
